@echo off
echo ===============================================
echo    AZEVIX - Teste de Conectividade SSM
echo ===============================================
echo.

:: Verifica se o AWS CLI está configurado
aws sts get-caller-identity >nul 2>&1
if %errorlevel% neq 0 (
    echo ERRO: AWS CLI não está configurado ou não tem permissões adequadas.
    echo Execute: aws configure
    pause
    exit /b 1
)

:: Obtém o Instance ID do Terraform
echo [INFO] Obtendo Instance ID...
for /f "tokens=*" %%i in ('terraform output -raw instance_id') do set INSTANCE_ID=%%i
echo [INFO] Instance ID: %INSTANCE_ID%

:: Verifica se a instância está no SSM
echo.
echo [INFO] Verificando status da instância no SSM...
aws ssm describe-instance-information --filters "Key=InstanceIds,Values=%INSTANCE_ID%" --query "InstanceInformationList[0].[InstanceId,PingStatus,LastPingDateTime]" --output table

:: Teste básico de conectividade
echo.
echo [INFO] Testando conectividade básica...
for /f "tokens=*" %%i in ('aws ssm send-command --instance-ids "%INSTANCE_ID%" --document-name "AWS-RunShellScript" --parameters "commands=[\"echo SSM is working; whoami; pwd\"]" --query "Command.CommandId" --output text') do set COMMAND_ID=%%i

echo [INFO] Command ID: %COMMAND_ID%
echo [INFO] Aguardando execução...

:: Aguarda 5 segundos
timeout /t 5 /nobreak >nul

:: Verifica o resultado
aws ssm get-command-invocation --command-id "%COMMAND_ID%" --instance-id "%INSTANCE_ID%" --query "StandardOutputContent" --output text

echo.
echo [INFO] Se você viu "SSM is working" acima, o SSM está funcionando corretamente.
echo [INFO] Se não, verifique os logs de erro:

aws ssm get-command-invocation --command-id "%COMMAND_ID%" --instance-id "%INSTANCE_ID%" --query "StandardErrorContent" --output text

echo.
echo [INFO] Status do comando:
aws ssm get-command-invocation --command-id "%COMMAND_ID%" --instance-id "%INSTANCE_ID%" --query "Status" --output text

echo.
echo ===============================================
echo    TESTE CONCLUÍDO
echo ===============================================
pause