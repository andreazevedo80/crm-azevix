{% extends "base.html" %}

{% block title %}Proposta {{ proposta.numero_proposta }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-azevix mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Proposta {{ proposta.numero_proposta }}</h1>
    <a href="{{ url_for('contas.detalhe_conta', conta_id=proposta.lead.conta_id) }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar para a Conta</a>
</div>

<!-- NOVO: Card de Resumo Financeiro -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card card-azevix text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Valor Total da Proposta</h6>
                <h4 id="summary-valor-total" class="card-title text-success">R$ 0,00</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-azevix text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Custo Total Estimado</h6>
                <h4 id="summary-custo-total" class="card-title text-danger">R$ 0,00</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-azevix text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Lucro Líquido Estimado</h6>
                <h4 id="summary-lucro-liquido" class="card-title text-primary">R$ 0,00</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Card dos Itens da Proposta (mantido original) -->
        <div class="card card-azevix">
            <div class="card-header"><h5 class="card-title mb-0">Itens da Proposta</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead><tr><th>Descrição</th><th class="text-center">Qtd.</th><th class="text-end">Valor Unit.</th><th class="text-end">Valor Total</th><th>Ações</th></tr></thead>
                        <tbody id="itens-proposta-table"></tbody>
                        <tfoot>
                            <tr class="fw-bold">
                                <td colspan="3" class="text-end">Subtotal:</td>
                                <td id="subtotal-proposta" class="text-end"></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Card para Adicionar Novo Item (mantido original) -->
        <div class="card card-azevix mt-4">
            <div class="card-header"><h5 class="card-title mb-0">Adicionar Novo Item</h5></div>
            <div class="card-body">
                <form id="form-add-item">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="item-catalogo" class="form-label">Item do Catálogo (Opcional)</label>
                            <select id="item-catalogo" class="form-select"></select>
                        </div>
                        <div class="col-md-4">
                            <label for="item-descricao" class="form-label">Descrição *</label>
                            <input type="text" id="item-descricao" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label for="item-qtd" class="form-label">Quantidade *</label>
                            <input type="number" id="item-qtd" class="form-control" value="1" step="0.01" required>
                        </div>
                        <div class="col-md-2">
                            <label for="item-valor" class="form-label">Valor Unit. (R$) *</label>
                            <input type="number" id="item-valor" class="form-control" step="0.01" required>
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-azevix w-100">Adicionar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card card-azevix mb-4">
            <div class="card-header"><h5 class="card-title mb-0">Informações Gerais</h5></div>
            <div class="card-body">
                <form id="form-general-info">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="proposta-contato" class="form-label">Contato Principal</label>
                            <select id="proposta-contato" class="form-select"></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="proposta-data-envio" class="form-label">Data de Envio</label>
                            <input type="date" id="proposta-data-envio" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="proposta-data-validade" class="form-label">Data de Validade</label>
                            <input type="date" id="proposta-data-validade" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NOVO: Coluna lateral com Card dos Custos da Proposta -->
    <div class="col-lg-4">
        <!-- NOVO: Card Status e Ciclo de Vida -->
        <div class="card card-azevix mb-4">
            <div class="card-header"><h5 class="card-title mb-0">Status e Ciclo de Vida</h5></div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="proposta-status" class="form-label">Status da Proposta</label>
                    <select id="proposta-status" class="form-select">
                        <option value="Em elaboração">Em elaboração</option>
                        <option value="Enviada">Enviada</option>
                        <option value="Aceita">Aceita</option>
                        <option value="Recusada">Recusada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-6 mb-3"><label for="proposta-data-envio" class="form-label">Data de Envio</label><input type="date" id="proposta-data-envio" class="form-control"></div>
                    <div class="col-6 mb-3"><label for="proposta-data-validade" class="form-label">Data de Validade</label><input type="date" id="proposta-data-validade" class="form-control"></div>
                </div>
                <div class="d-grid gap-2">
                    <button id="btn-save-status" class="btn btn-azevix">Salvar Alterações de Status</button>
                    <button id="btn-duplicate-proposta" class="btn btn-outline-secondary">Duplicar Proposta (Criar v2)</button>
                </div>
            </div>
        </div>
        
        <div class="card card-azevix">
            <div class="card-header"><h5 class="card-title mb-0">Custos da Proposta</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead><tr><th>Descrição</th><th class="text-end">Valor</th><th>Ações</th></tr></thead>
                        <tbody id="custos-proposta-table"></tbody>
                    </table>
                </div>
                <hr>
                <h6 class="mt-3">Adicionar Novo Custo</h6>
                <form id="form-add-custo">
                    <div class="row g-2">
                        <div class="col-12">
                            <label for="custo-descricao" class="form-label">Descrição *</label>
                            <input type="text" id="custo-descricao" class="form-control" required>
                        </div>
                        <div class="col-6">
                            <label for="custo-tipo" class="form-label">Tipo *</label>
                            <select id="custo-tipo" class="form-select">
                                <option value="Fixo">Fixo (R$)</option>
                                <option value="Percentual">Percentual (%)</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="custo-valor" class="form-label">Valor *</label>
                            <input type="number" step="0.01" id="custo-valor" class="form-control" required>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-sm btn-outline-primary w-100">Adicionar Custo</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const PROPOSTA_ID = {{ proposta.id }};
</script>
<script src="{{ url_for('static', filename='js/detalhe_proposta.js') }}"></script>
{% endblock %}